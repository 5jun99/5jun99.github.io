---
title: "JPA N+1 ë¬¸ì œ í•´ê²°, Jmeter ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
date: 2025-08-22
categories: [Spring]
tags: []
---

## ğŸ“‹ ëª©ì°¨

1. [ë¬¸ì œ ë°œê²¬: N+1 ë¬¸ì œë€?](#ë¬¸ì œ-ë°œê²¬-n1-ë¬¸ì œë€)
2. [í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±](#í…ŒìŠ¤íŠ¸-í™˜ê²½-êµ¬ì„±)
3. [6ê°€ì§€ ì¿¼ë¦¬ ìµœì í™” ë°©ì‹ ë¹„êµ](#6ê°€ì§€-ì¿¼ë¦¬-ìµœì í™”-ë°©ì‹-ë¹„êµ)
4. [ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼](#ì„±ëŠ¥-í…ŒìŠ¤íŠ¸-ê²°ê³¼)
5. [ë°°ì¹˜ ì¡°íšŒ: ê²Œì„ ì²´ì¸ì €](#ë°°ì¹˜-ì¡°íšŒ-ê²Œì„-ì²´ì¸ì €)
6. [ì‹¤ë¬´ ì ìš© ê°€ì´ë“œ](#ì‹¤ë¬´-ì ìš©-ê°€ì´ë“œ)

---

## ë¬¸ì œ ë°œê²¬: N+1 ë¬¸ì œë€?

```java

@Service
public class AnnotationService {
    public AnnotationListResponse loadAnnotations(Integer imageId) {
        List<Annotation> annotations = annotationRepository.findByImageId(imageId);
        return annotations.stream()
                .map(AnnotationResponse::from)  // ì—¬ê¸°ì„œ N+1 ë°œìƒ
                .collect(toList());
    }
}
```

### ì‹¤ì œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë“¤

```sql
-- 1ê°œ ì¿¼ë¦¬: Annotation ì¡°íšŒ
SELECT *
FROM annotations
WHERE image_id = ?

-- Nê°œ ì¿¼ë¦¬: ê° Annotationë§ˆë‹¤ User ì¡°íšŒ
SELECT *
FROM users
WHERE id = ? -- Annotation 1ì˜ annotated_by
SELECT *
FROM users
WHERE id = ? -- Annotation 2ì˜ annotated_by
SELECT *
FROM users
WHERE id = ? -- Annotation 3ì˜ annotated_by
               ...

-- N*Mê°œ ì¿¼ë¦¬: ê° Annotationë§ˆë‹¤ Shapeë“¤ ì¡°íšŒ
               SELECT *
FROM shapes
WHERE annotation_id = ?
    ...
```

**ê²°ê³¼**: Annotation 50ê°œ â†’ **2,551ê°œ ì¿¼ë¦¬** ì‹¤í–‰

---

## í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±

### ì—”í‹°í‹° ê´€ê³„ë„

```
Annotation (1) â”€â”€â”€ (N) Shape (1) â”€â”€â”€ (N) Coordinate
     â”‚
     â””â”€â”€ (N) â”€â”€â”€ (1) User
     â””â”€â”€ (N) â”€â”€â”€ (1) Image
```

### í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‹œë‚˜ë¦¬ì˜¤

| ì‹œë‚˜ë¦¬ì˜¤ | Annotation ìˆ˜ | Shape/Annotation | Coordinate/Shape | ì´ Coordinate |
| -------- | ------------- | ---------------- | ---------------- | ------------- |
| ê¸°ë³¸     | 5ê°œ           | 2ê°œ              | 10ê°œ             | 100ê°œ         |
| Hard     | 20ê°œ          | 5ê°œ              | 15ê°œ             | 1,500ê°œ       |
| Mad      | 50ê°œ          | 10ê°œ             | 25ê°œ             | 12,500ê°œ      |

### JMeter ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì„¤ì •

- **ë™ì‹œ ì‚¬ìš©ì**: 10~50ëª…
- **ìš”ì²­ ìˆ˜**: 1,000íšŒ
- **ì¸¡ì • í•­ëª©**: ì‘ë‹µì‹œê°„, TPS, ì—ëŸ¬ìœ¨

---

## 6ê°€ì§€ ì¿¼ë¦¬ ìµœì í™” ë°©ì‹ ë¹„êµ

### 1ï¸âƒ£ N+1 ë°©ì‹ (ê¸°ì¤€ì )

```java

@Query("SELECT a FROM Annotation a WHERE a.image.id = :imageId")
List<Annotation> findByImageId(Integer imageId);
```

- **ì¿¼ë¦¬ ìˆ˜**: 1 + N + NÃ—M + NÃ—MÃ—L
- **íŠ¹ì§•**: ê°€ì¥ ë‹¨ìˆœí•˜ì§€ë§Œ ì„±ëŠ¥ ìµœì•…

### 2ï¸âƒ£ EntityGraph ë°©ì‹

```java

@EntityGraph(attributePaths = {"annotatedBy", "image"})
@Query("SELECT a FROM Annotation a WHERE a.image.id = :imageId")
List<Annotation> findByImageIdWithEntityGraph(Integer imageId);
```

- **ì¿¼ë¦¬ ìˆ˜**: 1ê°œ (JOIN ì‚¬ìš©)
- **íŠ¹ì§•**: ê°„ë‹¨í•œ ê´€ê³„ì— íš¨ê³¼ì 

### 3ï¸âƒ£ Fetch Join ë°©ì‹

```java

@Query("SELECT a FROM Annotation a " +
        "JOIN FETCH a.annotatedBy " +
        "JOIN FETCH a.image " +
        "WHERE a.image.id = :imageId")
List<Annotation> findByImageIdWithFetchJoin(Integer imageId);
```

- **ì¿¼ë¦¬ ìˆ˜**: 1ê°œ (ëª…ì‹œì  JOIN)
- **íŠ¹ì§•**: EntityGraphë³´ë‹¤ ëª…í™•í•œ ì œì–´

### 4ï¸âƒ£ ëª¨ë“  ê´€ê³„ JOIN (ìœ„í—˜)

```java

@EntityGraph(attributePaths = {"annotatedBy", "image", "shapes", "shapes.coordinates"})
@Query("SELECT DISTINCT a FROM Annotation a WHERE a.image.id = :imageId")
List<Annotation> findByImageIdWithAllRelations(Integer imageId);
```

- **ì¿¼ë¦¬ ìˆ˜**: 1ê°œ (ë³µì¡í•œ JOIN)
- **íŠ¹ì§•**: ë°ì´í„° í­ë°œë¡œ ì¸í•œ ì„±ëŠ¥ ê¸‰ë½ ìœ„í—˜

### 5ï¸âƒ£ ë°°ì¹˜ ì¡°íšŒ ë°©ì‹

```java
// 1. Annotationë§Œ ì¡°íšŒ
List<Annotation> annotations = repository.findByImageId(imageId);


// 2. Userë“¤ ë°°ì¹˜ ì¡°íšŒ
List<Integer> annotationIds = annotations.stream().map(Annotation::getId).toList();
List<User> users = repository.findUsersByAnnotationIds(annotationIds);
Map<Integer, User> userMap = users.stream().collect(toMap(User::getId, identity()));

// 3. Shapeë“¤ ë°°ì¹˜ ì¡°íšŒ
List<Shape> shapes = shapeRepository.findByAnnotationIdIn(annotationIds);

// 4. Coordinateë“¤ ë°°ì¹˜ ì¡°íšŒ
List<Integer> shapeIds = shapes.stream().map(Shape::getId).toList();
List<Coordinate> coordinates = coordinateRepository.findByShapeIdIn(shapeIds);

// 5. ë©”ëª¨ë¦¬ì—ì„œ ê´€ê³„ ë§¤í•‘

- ì¿¼ë¦¬ ìˆ˜: 4ê°œ (ê³ ì •)
- íŠ¹ì§•: ë°ì´í„° ì–‘ê³¼ ë¬´ê´€í•˜ê²Œ ì¼ì •í•œ ì„±ëŠ¥
```

---

## ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ì‘ë‹µì‹œê°„ ë¹„êµ (Average)

| ë°©ì‹            | ê¸°ë³¸ (5ê°œ) | Hard (20ê°œ) | Mad (50ê°œ)  | ê°œì„ ìœ¨    |
| --------------- | ---------- | ----------- | ----------- | --------- |
| **N+1 ë°©ì‹**    | 628ms      | 2,624ms     | 12,556ms    | -         |
| **EntityGraph** | 570ms      | 7,145ms     | 12,602ms    | 9%        |
| **Fetch Join**  | **537ms**  | 2,187ms     | 12,556ms    | **14%**   |
| **ë°°ì¹˜ ì¡°íšŒ**   | **3ms**    | **303ms**   | **2,199ms** | **97.8%** |

### ë°œê²¬ì‚¬í•­

#### 1.

```

ê¸°ë³¸ ë°ì´í„° (5ê°œ Annotation):
âœ… Fetch Join: 537ms (ìµœì )

Mad ë°ì´í„° (50ê°œ Annotation):
âŒ Fetch Join: 12,556ms (ìµœì•…)
âœ… ë°°ì¹˜ ì¡°íšŒ: 2,199ms (ìµœì )

```

#### 2. ë°ì´í„° í¬ê¸°ë³„ ì„±ëŠ¥ ê²©ì°¨

- **ê¸°ë³¸ â†’ Mad**: Fetch Joinì€ **23ë°°** ì„±ëŠ¥ ì €í•˜
- **ê¸°ë³¸ â†’ Mad**: ë°°ì¹˜ ì¡°íšŒëŠ” **733ë°°**ë§Œ ì„±ëŠ¥ ì €í•˜

#### 3. ì²˜ë¦¬ëŸ‰(TPS) ì°¨ì´

- **ë°°ì¹˜ ì¡°íšŒ**: 992 TPS vs **N+1**: 104 TPS
- **9.5ë°° ì²˜ë¦¬ëŸ‰ í–¥ìƒ**

---

## ì ìš©

#### 1. ê°„ë‹¨í•œ ê´€ê³„ (1-2 depth)

```java
// âœ… Fetch Join ì‚¬ìš©
@Query("SELECT a FROM Annotation a JOIN FETCH a.annotatedBy WHERE a.image.id = :imageId")
```

- **ì¡°ê±´**: ê´€ê³„ê°€ ì ê³  ë°ì´í„°ëŸ‰ì´ ì˜ˆì¸¡ ê°€ëŠ¥
- **ì¥ì **: ê°„ë‹¨í•˜ê³  ì§ê´€ì 

#### 2. ë³µì¡í•œ ê´€ê³„ (3+ depth)

```java
// âœ… ë°°ì¹˜ ì¡°íšŒ ì‚¬ìš©
List<Entity> entities = repository.findByCondition();
Map<Integer, RelatedEntity> relatedMap = getRelatedEntities(entityIds);
```

- **ì¡°ê±´**: ê´€ê³„ê°€ ë³µì¡í•˜ê±°ë‚˜ ë°ì´í„°ëŸ‰ì´ ë§ìŒ
- **ì¥ì **: ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì„±ëŠ¥, ë©”ëª¨ë¦¬ íš¨ìœ¨ì 

#### 3. ì½ê¸° ì „ìš© + ì„±ëŠ¥ í¬ë¦¬í‹°ì»¬

```java
// âœ… DTO Projection ì‚¬ìš©
@Query("SELECT new com.example.AnnotationDto(a.id, u.name, i.url) " +
        "FROM Annotation a JOIN a.annotatedBy u JOIN a.image i " +
        "WHERE a.image.id = :imageId")
```

- **ì¡°ê±´**: íŠ¹ì • í•„ë“œë§Œ í•„ìš”í•˜ê³  ì„±ëŠ¥ì´ ìµœìš°ì„ 
- **ì¥ì **: ìµœì†Œí•œì˜ ë°ì´í„° ì „ì†¡, ìµœê³  ì„±ëŠ¥

---

## ğŸ“ ê²°ë¡ 

1. **"í•­ìƒ JOINì´ ì¢‹ì€ ê±´ ì•„ë‹ˆë‹¤"**

   - ê°„ë‹¨í•œ ê´€ê³„: JOIN ìš°ìˆ˜
   - ë³µì¡í•œ ê´€ê³„: ë°°ì¹˜ ì¡°íšŒ ì••ìŠ¹

2. **ë°ì´í„° í¬ê¸°ì— ë”°ë¥¸ ì „ëµ ìˆ˜ë¦½**

   - ì‘ì€ ë°ì´í„°: í¸ì˜ì„± ì¤‘ì‹¬
   - í° ë°ì´í„°: ì„±ëŠ¥ ì¤‘ì‹¬

3. **ì‹¤ì œ ì¸¡ì •ì„ ê¼­ í•´ë³´ì**
